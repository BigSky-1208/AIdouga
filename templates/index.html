<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Tab Screen Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-disabled { cursor: not-allowed; opacity: 0.5; }
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-8">
        <div class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">タブ画面キャプチャーツール</h1>
            <p class="text-center text-gray-500 mb-6">ユーザーが指定したブラウザのタブを5秒ごとに自動でスクリーンショットします。</p>

            <!-- 操作ガイド -->
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded-md">
                <h3 class="font-bold">使い方:</h3>
                <ol class="list-decimal list-inside mt-2 text-sm">
                    <li>キャプチャーしたいYouTube動画を別のタブで開いて再生してください。</li>
                    <li>下の「共有を開始」ボタンを押し、ブラウザの指示に従ってそのYouTubeタブを選択します。</li>
                    <li>キャプチャーが自動で開始されます。</li>
                </ol>
            </div>

            <!-- 操作ボタン -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="startButton" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition-transform transform hover:scale-105">
                    共有を開始
                </button>
                <button id="stopButton" class="px-8 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform transform hover:scale-105 btn-disabled" disabled>
                    共有を停止
                </button>
            </div>

            <!-- ステータス表示 -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h2 class="font-semibold text-gray-700 mb-2">現在のステータス:</h2>
                <div id="status" class="text-gray-600 bg-white p-3 rounded-md min-h-[40px] flex items-center">
                    待機中
                </div>
            </div>

            <!-- 結果表示 -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h2 class="font-semibold text-gray-700 mb-2">スクリーンショット一覧:</h2>
                <div id="results" class="bg-white p-4 rounded-md min-h-[200px] max-h-[400px] overflow-y-auto screenshot-grid">
                    <!-- ここにスクリーンショット画像が追加されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- 内部処理用の非表示ビデオ要素 -->
    <video id="video" playsinline autoplay muted style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');

        let captureInterval;
        let mediaStream;

        startButton.addEventListener('click', startCapture);
        stopButton.addEventListener('click', stopCapture);

        async function startCapture() {
            try {
                // 画面共有をリクエスト (タブ共有を推奨)
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: "tab" }, // Chrome 107+
                    audio: false
                });

                videoElement.srcObject = mediaStream;
                setControls(true);
                statusDiv.textContent = 'キャプチャー中です...';
                
                // ストリームが終了した（ユーザーが共有を停止した）場合の処理
                mediaStream.getVideoTracks()[0].onended = () => stopCapture();

                // 5秒ごとにスクリーンショットを撮る
                captureInterval = setInterval(() => {
                    takeScreenshot();
                }, 5000);

            } catch (err) {
                console.error("画面共有エラー:", err);
                statusDiv.textContent = 'エラー: 画面共有を開始できませんでした。';
            }
        }

        function stopCapture() {
            if (captureInterval) clearInterval(captureInterval);
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            setControls(false);
            statusDiv.textContent = '停止しました。';
        }

        function takeScreenshot() {
            const context = canvasElement.getContext('2d');
            const videoTrack = mediaStream.getVideoTracks()[0];
            const { width, height } = videoTrack.getSettings();

            if (!width || !height) return;

            canvasElement.width = width;
            canvasElement.height = height;

            context.drawImage(videoElement, 0, 0, width, height);
            
            // 画像を作成して表示
            const img = document.createElement('img');
            img.src = canvasElement.toDataURL('image/jpeg');
            img.className = 'rounded-md shadow-md';
            resultsDiv.appendChild(img);
            resultsDiv.scrollTop = resultsDiv.scrollHeight; // 自動スクロール
        }

        function setControls(isCapturing) {
            startButton.disabled = isCapturing;
            stopButton.disabled = !isCapturing;
            
            if(isCapturing) {
                startButton.classList.add('btn-disabled');
                stopButton.classList.remove('btn-disabled');
                resultsDiv.innerHTML = ''; // 開始時に結果をクリア
            } else {
                startButton.classList.remove('btn-disabled');
                stopButton.classList.add('btn-disabled');
            }
        }
    </script>
</body>
</html>

